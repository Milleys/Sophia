<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take 3 Pictures</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body::before {
            content: "";
            background: url('img/bg.png') no-repeat center center/cover;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.3;
            z-index: -1;
        }
        video {
            border-radius: 15px;
            width: 100%;
            max-width: 300px;
        }
        canvas {
            border-radius: 0px;
            width: 100%;
            max-width: 300px;
            background-color: lightgray;
            border: 2px dashed gray;
        }
        .photo-frame {
            border: 5px solid white;
            background-color: white;
            padding: 10px;
        }
        .btn-pink {
            background-color: #ff4d6d;
            color: white;
            border: none;
            font-size: 14px;
            padding: 8px 15px;
        }
        .btn-pink:hover {
            background-color: #e63956;
            color: white;
        }
        .btn-red {
            background-color: #d62828;
            color: white;
            border: none;
            font-size: 14px;
            padding: 8px 15px;
        }
        .btn-red:hover {
            background-color: #a61d1d;
            color: white;
        }
        .signature {
            font-family: cursive;
            font-size: 24px;
            color: #d62828;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">üì∏ Take 3 Pictures</h1>
        <div class="row justify-content-center">
            <div class="col-md-5 text-center">
                <h5>Photo Booth</h5>
                <video id="camera" autoplay playsinline muted></video>
                <div class="mt-3">
                    <input type="text" id="userName" class="form-control w-25 mx-auto" placeholder="Enter your name">
                </div>
                <div class="mt-3">
                    <button id="captureBtn" class="btn btn-pink btn-md rounded-pill shadow-sm">
                        ‚ù§Ô∏è Capture Love
                    </button>
                    <button id="retakeBtn" class="btn btn-light text-danger btn-md rounded-pill border border-danger shadow-sm" style="display: none;">
                        üîÑ Try Again, Cupid!
                    </button>
                    <button id="downloadBtn" class="btn btn-red btn-md rounded-pill shadow-sm" style="display: none;">
                        üíå Save Memory
                    </button>
                </div>
            </div>
            <div class="col-md-5 text-center">
                <div class="d-flex flex-column align-items-center">
                    <canvas id="canvas1" class="photo-frame"></canvas>
                    <canvas id="canvas2" class="photo-frame"></canvas>
                    <canvas id="canvas3" class="photo-frame"></canvas>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-end pe-3 mt-5">
        <p class="signature">-Wil</p>
    </footer>

    <script>
        const video = document.getElementById("camera");
        const captureBtn = document.getElementById("captureBtn");
        const retakeBtn = document.getElementById("retakeBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const userNameInput = document.getElementById("userName");
    
        const canvas1 = document.getElementById("canvas1");
        const canvas2 = document.getElementById("canvas2");
        const canvas3 = document.getElementById("canvas3");
    
        let captureCount = 0;
        let capturedImages = [];
    
        // Function to detect if the user is on a mobile device
        function isMobile() {
            return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        }
    
        // Function to start the camera
        function startCamera() {
            let constraints = {
                video: {
                    facingMode: isMobile() ? { exact: "environment" } : "user"
                }
            };
    
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(error => {
                    console.error("Error accessing camera:", error);
                    alert("Camera access is required!");
                });
        }
    
        // Ensure camera starts only after user interaction (fixes iOS autoplay restrictions)
        document.addEventListener("DOMContentLoaded", () => {
            document.body.addEventListener("click", () => {
                if (!video.srcObject) {
                    startCamera();
                }
            }, { once: true });
        });
    
        // Capture Image
        captureBtn.addEventListener("click", function () {
            if (captureCount < 3) {
                let canvas = [canvas1, canvas2, canvas3][captureCount];
                let context = canvas.getContext("2d");
                canvas.width = video.videoWidth / 2;
                canvas.height = video.videoHeight / 2;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.style.display = "block";
                capturedImages.push(canvas.toDataURL("image/png"));
                captureCount++;
            }
            if (captureCount === 3) {
                createFinalImage();
                retakeBtn.style.display = "inline-block";
            }
        });
    
        // Retake Pictures
        retakeBtn.addEventListener("click", function () {
            captureCount = 0;
            capturedImages = [];
            canvas1.style.display = "none";
            canvas2.style.display = "none";
            canvas3.style.display = "none";
            downloadBtn.style.display = "none";
            retakeBtn.style.display = "none";
        });
    
        // Combine 3 Images Vertically
        function createFinalImage() {
            let finalCanvas = document.createElement("canvas");
            let context = finalCanvas.getContext("2d");
    
            let imgHeight = canvas1.height;
            let imgWidth = canvas1.width;
    
            finalCanvas.width = imgWidth;
            finalCanvas.height = imgHeight * 3 + 80;
    
            context.fillStyle = "white";
            context.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
    
            let yOffset = 10;
            for (let i = 0; i < capturedImages.length; i++) {
                let img = new Image();
                img.src = capturedImages[i];
                img.onload = function () {
                    context.drawImage(img, 10, yOffset, imgWidth - 20, imgHeight - 20);
                    yOffset += imgHeight + 10;
    
                    if (i === 2) {
                        let userName = userNameInput.value || " ";
                        let currentDate = new Date().toLocaleDateString();
    
                        context.fillStyle = "black";
                        context.font = "20px 'Great Vibes', cursive";
                        context.textAlign = "left";
                        context.fillText(userName, 10, yOffset + 5);
    
                        context.textAlign = "right";
                        context.fillText(currentDate, finalCanvas.width - 10, yOffset + 5);
    
                        downloadBtn.style.display = "inline-block";
                        downloadBtn.onclick = function () {
                            let imageData = finalCanvas.toDataURL("image/png");
                            let link = document.createElement("a");
                            link.href = imageData;
                            link.download = "photo_strip.png";
                            link.click();
                        };
                    }
                };
            }
        }
    </script>
    
</body>
</html>
